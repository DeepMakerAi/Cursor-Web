<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能模块诊断</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 15px;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .module-card {
            background: #2d3748;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-left: 4px solid #718096;
            border: 1px solid #4a5568;
            transition: all 0.3s ease;
        }
        .module-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .module-card.success {
            border-left-color: #48bb78;
            border-color: #48bb78;
        }
        .module-card.error {
            border-left-color: #f56565;
            border-color: #f56565;
        }
        .module-card.warning {
            border-left-color: #ed8936;
            border-color: #ed8936;
        }
        .module-card.info {
            border-left-color: #4299e1;
            border-color: #4299e1;
        }

        .module-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #e2e8f0;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }
        .status-success { background-color: #48bb78; }
        .status-error { background-color: #f56565; }
        .status-warning { background-color: #ed8936; }
        .status-info { background-color: #4299e1; }

        .module-details {
            font-size: 11px;
            color: #a0aec0;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        .module-actions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .module-actions .btn {
            flex: 0 0 auto;
        }
        .btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s ease;
            min-width: 50px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn-primary { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; }
        .btn-info { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #718096 0%, #4a5568 100%); color: white; }

        .log-section {
            background: #2d3748;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #4a5568;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .log-header h3 {
            color: #e2e8f0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        #log {
            background-color: #1e1e1e;
            border: 1px solid #333;
            padding: 12px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            border-radius: 4px;
            color: #e0e0e0;
            line-height: 1.3;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-entry {
            margin-bottom: 2px;
            padding: 2px 0;
        }
        .log-entry.info { color: #87ceeb; }
        .log-entry.success { color: #90ee90; }
        .log-entry.warning { color: #ffd700; }
        .log-entry.error { color: #ff6b6b; }
        .summary {
            background: #2d3748;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 15px;
            border: 1px solid #4a5568;
        }
        .summary h3 {
            color: #e2e8f0;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .summary-item {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border: 1px solid #718096;
            transition: all 0.3s ease;
        }
        .summary-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-color: #90cdf4;
        }
        .summary-number {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 3px;
            color: #f7fafc;
        }
        .summary-label {
            font-size: 10px;
            color: #a0aec0;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="font-size: 18px; margin-bottom: 6px;">🔍 功能模块诊断</h1>
        <p style="font-size: 11px; margin-bottom: 0;">全面检查系统各个功能模块的状态和连接情况</p>
    </div>

    <div class="summary">
        <h3>📊 系统概览</h3>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-number" id="total-modules">0</div>
                <div class="summary-label">总模块数</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="loaded-modules">0</div>
                <div class="summary-label">已加载模块</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="ws-status">🔴</div>
                <div class="summary-label">WebSocket状态</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="client-status">🔴</div>
                <div class="summary-label">客户端状态</div>
            </div>
        </div>
    </div>

    <div class="diagnostic-grid">
        <!-- 模块加载器 -->
        <div class="module-card" id="module-loader-card">
            <div class="module-title">
                <span class="status-indicator" id="module-loader-status"></span>
                模块加载器
            </div>
            <div class="module-details" id="module-loader-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-primary" onclick="checkModuleLoader()">检查加载器</button>
                <button class="btn btn-success" onclick="loadAllModules()">加载所有模块</button>
            </div>
        </div>

        <!-- 错误处理器 -->
        <div class="module-card" id="error-handler-card">
            <div class="module-title">
                <span class="status-indicator" id="error-handler-status"></span>
                错误处理器
            </div>
            <div class="module-details" id="error-handler-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="testErrorHandler()">测试</button>
            </div>
        </div>

        <!-- WebSocket管理器 -->
        <div class="module-card" id="websocket-card">
            <div class="module-title">
                <span class="status-indicator" id="websocket-status"></span>
                WebSocket管理器
            </div>
            <div class="module-details" id="websocket-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-success" onclick="testWebSocket()">测试</button>
                <button class="btn btn-warning" onclick="reconnectWebSocket()">重连</button>
                <button class="btn btn-info" onclick="openWebSocketTest()">测试页面</button>
            </div>
        </div>

        <!-- 内容管理器 -->
        <div class="module-card" id="content-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="content-manager-status"></span>
                内容管理器
            </div>
            <div class="module-details" id="content-manager-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkContent()">检查</button>
            </div>
        </div>

        <!-- 状态管理器 -->
        <div class="module-card" id="status-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="status-manager-status"></span>
                状态管理器
            </div>
            <div class="module-details" id="status-manager-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkStatus()">检查</button>
            </div>
        </div>

        <!-- UI管理器 -->
        <div class="module-card" id="ui-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="ui-manager-status"></span>
                UI管理器
            </div>
            <div class="module-details" id="ui-manager-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="testUI()">测试</button>
            </div>
        </div>

        <!-- 事件管理器 -->
        <div class="module-card" id="event-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="event-manager-status"></span>
                事件管理器
            </div>
            <div class="module-details" id="event-manager-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkEvents()">检查</button>
            </div>
        </div>

        <!-- 调试管理器 -->
        <div class="module-card" id="debug-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="debug-manager-status"></span>
                调试管理器
            </div>
            <div class="module-details" id="debug-manager-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="getDebugInfo()">调试</button>
            </div>
        </div>

        <!-- 主客户端 -->
        <div class="module-card" id="simple-client-card">
            <div class="module-title">
                <span class="status-indicator" id="simple-client-status"></span>
                主客户端
            </div>
            <div class="module-details" id="simple-client-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-success" onclick="initClient()">初始化</button>
                <button class="btn btn-info" onclick="checkClient()">检查</button>
            </div>
        </div>
    </div>

    <div class="log-section">
        <div class="log-header">
            <h3>📝 诊断日志</h3>
            <div style="display: flex; gap: 6px;">
                <button class="btn btn-success" onclick="startDiagnostic()">🚀 开始诊断</button>
                <button class="btn btn-secondary" onclick="clearLog()">🧹 清除日志</button>
                <button class="btn btn-info" onclick="exportLog()">📤 导出日志</button>
            </div>
        </div>
        <div id="log"></div>
        </div>

    <script src="js/modules/module-loader.js"></script>
    <script>
        // 日志功能
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'ℹ️',
                'success': '✅',
                'warning': '⚠️',
                'error': '❌'
            };

            // 处理换行符
            const lines = message.split('\n');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;

            lines.forEach((line, index) => {
                if (index === 0) {
                    logEntry.innerHTML = `[${timestamp}] ${typeIcon[type]} ${line}`;
                } else {
                    logEntry.innerHTML += `<br>${' '.repeat(timestamp.length + 3)}${line}`;
                }
            });

            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // 等待模块加载器初始化
        function waitForModuleLoader() {
            return new Promise((resolve) => {
                const checkLoader = () => {
                    if (window.ModuleLoader) {
                        log('✅ 模块加载器已就绪', 'success');
                        resolve();
                    } else {
                        log('⏳ 等待模块加载器...', 'info');
                        setTimeout(checkLoader, 100);
                    }
                };
                checkLoader();
            });
        }

        // 更新模块卡片状态
        function updateModuleCard(moduleId, status, details, className = 'info') {
            const card = document.getElementById(`${moduleId}-card`);
            const statusIndicator = document.getElementById(`${moduleId}-status`);
            const detailsElement = document.getElementById(`${moduleId}-details`);

            card.className = `module-card ${className}`;
            statusIndicator.className = `status-indicator status-${className}`;
            detailsElement.textContent = details;
        }

        // 更新概览
        function updateSummary() {
            const modules = ['ErrorHandler', 'WebSocketManager', 'ContentManager', 'StatusManager', 'UIManager', 'EventManager', 'DebugManager'];
            const loadedModules = modules.filter(m => window[m]).length;

            document.getElementById('total-modules').textContent = modules.length;
            document.getElementById('loaded-modules').textContent = loadedModules;

            if (window.simpleClient && window.simpleClient.wsManager && window.simpleClient.wsManager.isConnected()) {
                document.getElementById('ws-status').textContent = '🟢';
            } else {
                document.getElementById('ws-status').textContent = '🔴';
            }

            if (window.simpleClient) {
                document.getElementById('client-status').textContent = '🟢';
            } else {
                document.getElementById('client-status').textContent = '🔴';
            }
        }

        // 检查模块加载器
        function checkModuleLoader() {
            log('🔍 检查模块加载器...');
            if (window.ModuleLoader) {
                const status = window.ModuleLoader.getLoadStatus();
                updateModuleCard('module-loader', 'success',
                    `已加载: ${status.loadedModules.length}/${status.totalModules}`, 'success');
                log('✅ 模块加载器正常', 'success');
                log(`📊 加载状态: ${status.loadedModules.join(', ')}`, 'info');
            } else {
                updateModuleCard('module-loader', 'error', '模块加载器未加载', 'error');
                log('❌ 模块加载器未找到', 'error');
            }
        }

        // 加载所有模块
        async function loadAllModules() {
            log('📦 开始加载所有模块...');
            if (window.ModuleLoader) {
                try {
                    await window.ModuleLoader.loadAllModules();
                    log('✅ 所有模块加载完成', 'success');

                    // 检查模块可用性
                    if (window.ModuleLoader.checkModulesAvailability()) {
                        log('✅ 所有模块可用', 'success');

                        // 加载主客户端
                        if (!window.SimpleWebClient) {
                            log('📦 加载主客户端...', 'info');
                            try {
                                await window.ModuleLoader.loadModule('SimpleWebClient');
                                log('✅ SimpleWebClient 加载完成', 'success');
                            } catch (error) {
                                log(`❌ SimpleWebClient 加载失败: ${error.message}`, 'error');
                                return;
                            }
                        }

                        // 初始化客户端
                        if (window.SimpleWebClient && !window.simpleClient) {
                            log('🚀 初始化客户端...', 'info');
                            try {
                                window.simpleClient = new window.SimpleWebClient();
                                log('✅ 客户端初始化成功', 'success');
                            } catch (error) {
                                log(`❌ 客户端初始化失败: ${error.message}`, 'error');
                                return;
                            }
                        }

                        setTimeout(runFullDiagnostic, 1000);
                    } else {
                        log('❌ 部分模块不可用', 'error');
                    }
                } catch (error) {
                    log(`❌ 模块加载失败: ${error.message}`, 'error');
                }
            } else {
                log('❌ 模块加载器不可用', 'error');
            }
        }

        // 测试WebSocket
        function testWebSocket() {
            log('🔌 测试WebSocket连接...');
            if (window.simpleClient && window.simpleClient.wsManager) {
                const state = window.simpleClient.wsManager.getConnectionState();
                const connected = window.simpleClient.wsManager.isConnected();

                if (connected) {
                    updateModuleCard('websocket', 'success', 'WebSocket已连接', 'success');
                    log('✅ WebSocket连接正常', 'success');
                } else {
                    updateModuleCard('websocket', 'warning', `WebSocket状态: ${state}`, 'warning');
                    log(`⚠️ WebSocket未连接，状态: ${state}`, 'warning');
                }
            } else {
                updateModuleCard('websocket', 'error', 'WebSocket管理器未初始化', 'error');
                log('❌ WebSocket管理器不可用', 'error');
            }
        }

        // 重新连接WebSocket
        function reconnectWebSocket() {
            log('🔄 重新连接WebSocket...');
            if (window.simpleClient && window.simpleClient.wsManager) {
                window.simpleClient.wsManager.manualReconnect();
                log('🔄 WebSocket重连已触发', 'info');
                setTimeout(testWebSocket, 2000);
            } else {
                log('❌ WebSocket管理器不可用', 'error');
            }
        }

        // 打开WebSocket测试页面
        function openWebSocketTest() {
            log('🔗 打开WebSocket测试页面...');
            try {
                const testUrl = 'test-websocket.html';
                window.open(testUrl, '_blank');
                log('✅ WebSocket测试页面已在新标签页中打开', 'success');
            } catch (error) {
                log(`❌ 打开测试页面失败: ${error.message}`, 'error');
            }
        }

        // 发送测试消息
        function sendTestMessage() {
            log('📤 发送测试消息...');
            if (window.simpleClient) {
                const success = window.simpleClient.testSendMessage('诊断测试消息');
                if (success) {
                    log('✅ 测试消息发送成功', 'success');
                } else {
                    log('❌ 测试消息发送失败', 'error');
                }
            } else {
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 检查内容管理器
        function checkContent() {
            log('📄 检查内容管理器...');
            if (window.simpleClient) {
                log(`🔍 simpleClient存在: ${typeof window.simpleClient}`, 'info');
                log(`🔍 contentManager存在: ${!!window.simpleClient.contentManager}`, 'info');

                if (window.simpleClient.contentManager) {
                    log(`🔍 contentManager类型: ${typeof window.simpleClient.contentManager}`, 'info');
                    log(`🔍 hasReceivedContent方法存在: ${typeof window.simpleClient.contentManager.hasReceivedContent}`, 'info');

                    try {
                        const hasContent = window.simpleClient.contentManager.hasReceivedContent();
                        const currentContent = window.simpleClient.contentManager.getCurrentContent();

                        updateModuleCard('content-manager', 'success',
                            `内容状态: ${hasContent ? '有内容' : '无内容'}`, 'success');
                        log(`✅ 内容管理器正常，内容长度: ${currentContent ? currentContent.length : 0}`, 'success');
                    } catch (error) {
                        updateModuleCard('content-manager', 'error', `内容管理器错误: ${error.message}`, 'error');
                        log(`❌ 内容管理器调用失败: ${error.message}`, 'error');
                    }
                } else {
                    updateModuleCard('content-manager', 'error', '内容管理器未初始化', 'error');
                    log('❌ 内容管理器不可用', 'error');
                }
            } else {
                updateModuleCard('content-manager', 'error', '客户端未初始化', 'error');
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 清除内容
        function clearContent() {
            log('🧹 清除内容...');
            if (window.simpleClient) {
                window.simpleClient.forceClear();
                log('✅ 内容已清除', 'success');
                setTimeout(checkContent, 1000);
            } else {
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 检查状态管理器
        function checkStatus() {
            log('📊 检查状态管理器...');
            if (window.simpleClient) {
                log(`🔍 statusManager存在: ${!!window.simpleClient.statusManager}`, 'info');

                if (window.simpleClient.statusManager) {
                    try {
                        updateModuleCard('status-manager', 'success', '状态管理器正常', 'success');
                        log('✅ 状态管理器正常', 'success');
                    } catch (error) {
                        updateModuleCard('status-manager', 'error', `状态管理器错误: ${error.message}`, 'error');
                        log(`❌ 状态管理器调用失败: ${error.message}`, 'error');
                    }
                } else {
                    updateModuleCard('status-manager', 'error', '状态管理器未初始化', 'error');
                    log('❌ 状态管理器不可用', 'error');
                }
            } else {
                updateModuleCard('status-manager', 'error', '客户端未初始化', 'error');
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 开始状态检查
        function startStatusCheck() {
            log('🔄 开始状态检查...');
            if (window.simpleClient && window.simpleClient.statusManager) {
                window.simpleClient.statusManager.startStatusCheck();
                log('✅ 状态检查已启动', 'success');
            } else {
                log('❌ 状态管理器不可用', 'error');
            }
        }

        // 测试UI管理器
        function testUI() {
            log('🎨 测试UI管理器...');
            if (window.simpleClient) {
                log(`🔍 uiManager存在: ${!!window.simpleClient.uiManager}`, 'info');

                if (window.simpleClient.uiManager) {
                    try {
                        window.simpleClient.uiManager.updateStatus('UI测试 - 正常', 'info');
                        updateModuleCard('ui-manager', 'success', 'UI管理器正常', 'success');
                        log('✅ UI管理器正常', 'success');
                    } catch (error) {
                        updateModuleCard('ui-manager', 'error', `UI管理器错误: ${error.message}`, 'error');
                        log(`❌ UI管理器调用失败: ${error.message}`, 'error');
                    }
                } else {
                    updateModuleCard('ui-manager', 'error', 'UI管理器未初始化', 'error');
                    log('❌ UI管理器不可用', 'error');
                }
            } else {
                updateModuleCard('ui-manager', 'error', '客户端未初始化', 'error');
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 显示通知
        function showNotification() {
            log('🔔 显示通知...');
            if (window.simpleClient && window.simpleClient.uiManager) {
                window.simpleClient.uiManager.showNotification('诊断通知', 'info');
                log('✅ 通知已显示', 'success');
            } else {
                log('❌ UI管理器不可用', 'error');
            }
        }

        // 检查事件管理器
        function checkEvents() {
            log('🎯 检查事件管理器...');
            if (window.simpleClient) {
                log(`🔍 eventManager存在: ${!!window.simpleClient.eventManager}`, 'info');

                if (window.simpleClient.eventManager) {
                    try {
                        const events = window.simpleClient.eventManager.getBoundEvents();
                        updateModuleCard('event-manager', 'success',
                            `已绑定事件: ${events.length}个`, 'success');
                        log(`✅ 事件管理器正常，已绑定${events.length}个事件`, 'success');
                    } catch (error) {
                        updateModuleCard('event-manager', 'error', `事件管理器错误: ${error.message}`, 'error');
                        log(`❌ 事件管理器调用失败: ${error.message}`, 'error');
                    }
                } else {
                    updateModuleCard('event-manager', 'error', '事件管理器未初始化', 'error');
                    log('❌ 事件管理器不可用', 'error');
                }
            } else {
                updateModuleCard('event-manager', 'error', '客户端未初始化', 'error');
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 测试事件
        function testEvents() {
            log('🧪 测试事件...');
            if (window.simpleClient && window.simpleClient.eventManager) {
                window.simpleClient.eventManager.triggerEvent('diagnostic-test', { timestamp: Date.now() });
                log('✅ 测试事件已触发', 'success');
            } else {
                log('❌ 事件管理器不可用', 'error');
            }
        }

        // 获取调试信息
        function getDebugInfo() {
            log('🔍 获取调试信息...');
            if (window.simpleClient) {
                log(`🔍 debugManager存在: ${!!window.simpleClient.debugManager}`, 'info');

                if (window.simpleClient.debugManager) {
                    try {
                        const status = window.simpleClient.debugManager.getClientStatus();
                        updateModuleCard('debug-manager', 'success', '调试管理器正常', 'success');
                        log('✅ 调试信息已获取', 'success');
                        console.log('调试状态:', status);
                    } catch (error) {
                        updateModuleCard('debug-manager', 'error', `调试管理器错误: ${error.message}`, 'error');
                        log(`❌ 调试管理器调用失败: ${error.message}`, 'error');
                    }
                } else {
                    updateModuleCard('debug-manager', 'error', '调试管理器未初始化', 'error');
                    log('❌ 调试管理器不可用', 'error');
                }
            } else {
                updateModuleCard('debug-manager', 'error', '客户端未初始化', 'error');
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 导出调试数据
        function exportDebugData() {
            log('📤 导出调试数据...');
            if (window.simpleClient && window.simpleClient.debugManager) {
                const status = window.simpleClient.debugManager.getClientStatus();
                const dataStr = JSON.stringify(status, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `debug-data-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                log('✅ 调试数据已导出', 'success');
            } else {
                log('❌ 调试管理器不可用', 'error');
            }
        }

        // 初始化客户端
        function initClient() {
            log('🚀 初始化客户端...');
            if (window.SimpleWebClient) {
                try {
                    log('🔍 创建SimpleWebClient实例...', 'info');
                    window.simpleClient = new window.SimpleWebClient();

                    // 验证客户端是否正确初始化
                    log('🔍 验证客户端初始化...', 'info');
                    log(`🔍 simpleClient类型: ${typeof window.simpleClient}`, 'info');
                    log(`🔍 contentManager存在: ${!!window.simpleClient.contentManager}`, 'info');
                    log(`🔍 wsManager存在: ${!!window.simpleClient.wsManager}`, 'info');
                    log(`🔍 statusManager存在: ${!!window.simpleClient.statusManager}`, 'info');
                    log(`🔍 uiManager存在: ${!!window.simpleClient.uiManager}`, 'info');
                    log(`🔍 eventManager存在: ${!!window.simpleClient.eventManager}`, 'info');
                    log(`🔍 debugManager存在: ${!!window.simpleClient.debugManager}`, 'info');

                    updateModuleCard('simple-client', 'success', '客户端初始化成功', 'success');
                    log('✅ 客户端初始化成功', 'success');
                    setTimeout(runFullDiagnostic, 1000);
                } catch (error) {
                    updateModuleCard('simple-client', 'error', `客户端初始化失败: ${error.message}`, 'error');
                    log(`❌ 客户端初始化失败: ${error.message}`, 'error');
                    log(`🔍 错误堆栈: ${error.stack}`, 'error');
                }
            } else {
                updateModuleCard('simple-client', 'error', 'SimpleWebClient类不可用', 'error');
                log('❌ SimpleWebClient类不可用', 'error');
            }
        }

        // 检查客户端
        function checkClient() {
            log('🔍 检查客户端...');
            if (window.simpleClient) {
                const wsConnected = window.simpleClient.isConnected();
                const wsState = window.simpleClient.getConnectionState();

                updateModuleCard('simple-client', 'success',
                    `客户端正常，WebSocket: ${wsConnected ? '已连接' : '未连接'}`, 'success');
                log(`✅ 客户端正常，WebSocket状态: ${wsState}`, 'success');
            } else {
                updateModuleCard('simple-client', 'error', '客户端未初始化', 'error');
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 清理客户端
        function cleanupClient() {
            log('🧹 清理客户端...');
            if (window.simpleClient) {
                window.simpleClient.cleanup();
                log('✅ 客户端已清理', 'success');
            } else {
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 测试错误处理器
        function testErrorHandler() {
            log('🧪 测试错误处理器...');
            if (window.ErrorHandler && typeof window.ErrorHandler.handleError === 'function') {
                try {
                    throw new Error('测试错误');
                } catch (error) {
                    window.ErrorHandler.handleError(error, '诊断测试');
                }
                updateModuleCard('error-handler', 'success', '错误处理器正常', 'success');
                log('✅ 错误处理器测试完成', 'success');
            } else {
                updateModuleCard('error-handler', 'error', '错误处理器未正确加载', 'error');
                log('❌ 错误处理器不可用或方法缺失', 'error');
                if (window.ErrorHandler) {
                    log(`🔍 ErrorHandler对象: ${typeof window.ErrorHandler}`, 'info');
                    log(`🔍 handleError方法: ${typeof window.ErrorHandler.handleError}`, 'info');
                }
            }
        }

        // 清除错误日志
        function clearErrorLog() {
            log('🧹 清除错误日志...');
            if (window.ErrorHandler) {
                window.ErrorHandler.clearErrorLog();
                log('✅ 错误日志已清除', 'success');
            } else {
                log('❌ 错误处理器不可用', 'error');
            }
        }

        // 清除日志
        function clearLog() {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = '';
            log('🧹 诊断日志已清除', 'info');
        }

        // 导出日志
        function exportLog() {
            const logContent = document.getElementById('log').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostic-log-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('✅ 日志已导出', 'success');
        }

        // 运行完整诊断
        function runFullDiagnostic() {
            log('🔍 开始完整诊断...', 'info');

            // 检查各个模块
            checkModuleLoader();
            testErrorHandler();
            testWebSocket();
            checkContent();
            checkStatus();
            testUI();
            checkEvents();
            getDebugInfo();
            checkClient();

            // 更新概览
            updateSummary();

            log('✅ 完整诊断完成', 'success');
        }

        // 开始诊断
        async function startDiagnostic() {
            log('🚀 开始系统诊断...', 'info');
            clearLog();

            // 先检查模块加载器
            checkModuleLoader();

            // 如果模块加载器可用，尝试加载模块
            if (window.ModuleLoader) {
                log('📦 开始加载模块...', 'info');
                await loadAllModules();
            } else {
                log('❌ 模块加载器不可用，请刷新页面重试', 'error');
            }
        }

                // 页面加载完成后自动开始诊断
        window.addEventListener('load', async () => {
            log('📄 诊断页面加载完成', 'info');

            // 等待模块加载器就绪
            await waitForModuleLoader();

            // 开始诊断
            await startDiagnostic();
        });

        // 监听全局错误
        window.addEventListener('error', (event) => {
            log(`🔥 全局错误: ${event.error.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`🔥 未处理的Promise拒绝: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
