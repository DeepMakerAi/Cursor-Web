<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能模块诊断</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .module-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #ddd;
        }
        .module-card.success { border-left-color: #28a745; }
        .module-card.error { border-left-color: #dc3545; }
        .module-card.warning { border-left-color: #ffc107; }
        .module-card.info { border-left-color: #17a2b8; }

        .module-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }

        .module-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        .module-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-info { background-color: #17a2b8; color: white; }

        .log-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 5px;
        }
        .summary {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .summary-item {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .summary-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .summary-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔍 功能模块诊断</h1>
        <p>全面检查系统各个功能模块的状态和连接情况</p>
    </div>

    <div class="summary">
        <h3>📊 系统概览</h3>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-number" id="total-modules">0</div>
                <div class="summary-label">总模块数</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="loaded-modules">0</div>
                <div class="summary-label">已加载模块</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="ws-status">❌</div>
                <div class="summary-label">WebSocket状态</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="client-status">❌</div>
                <div class="summary-label">客户端状态</div>
            </div>
        </div>
    </div>

    <div class="diagnostic-grid">
        <!-- 模块加载器 -->
        <div class="module-card" id="module-loader-card">
            <div class="module-title">
                <span class="status-indicator" id="module-loader-status"></span>
                模块加载器
            </div>
            <div class="module-details" id="module-loader-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-primary" onclick="checkModuleLoader()">检查加载器</button>
                <button class="btn btn-success" onclick="loadAllModules()">加载所有模块</button>
            </div>
        </div>

        <!-- 错误处理器 -->
        <div class="module-card" id="error-handler-card">
            <div class="module-title">
                <span class="status-indicator" id="error-handler-status"></span>
                错误处理器
            </div>
            <div class="module-details" id="error-handler-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="testErrorHandler()">测试错误处理</button>
                <button class="btn btn-warning" onclick="clearErrorLog()">清除错误日志</button>
            </div>
        </div>

        <!-- WebSocket管理器 -->
        <div class="module-card" id="websocket-card">
            <div class="module-title">
                <span class="status-indicator" id="websocket-status"></span>
                WebSocket管理器
            </div>
            <div class="module-details" id="websocket-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-success" onclick="testWebSocket()">测试连接</button>
                <button class="btn btn-warning" onclick="reconnectWebSocket()">重新连接</button>
                <button class="btn btn-info" onclick="sendTestMessage()">发送测试消息</button>
            </div>
        </div>

        <!-- 内容管理器 -->
        <div class="module-card" id="content-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="content-manager-status"></span>
                内容管理器
            </div>
            <div class="module-details" id="content-manager-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkContent()">检查内容</button>
                <button class="btn btn-warning" onclick="clearContent()">清除内容</button>
            </div>
        </div>

        <!-- 状态管理器 -->
        <div class="module-card" id="status-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="status-manager-status"></span>
                状态管理器
            </div>
            <div class="module-details" id="status-manager-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkStatus()">检查状态</button>
                <button class="btn btn-warning" onclick="startStatusCheck()">开始状态检查</button>
            </div>
        </div>

        <!-- UI管理器 -->
        <div class="module-card" id="ui-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="ui-manager-status"></span>
                UI管理器
            </div>
            <div class="module-details" id="ui-manager-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="testUI()">测试UI更新</button>
                <button class="btn btn-warning" onclick="showNotification()">显示通知</button>
            </div>
        </div>

        <!-- 事件管理器 -->
        <div class="module-card" id="event-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="event-manager-status"></span>
                事件管理器
            </div>
            <div class="module-details" id="event-manager-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkEvents()">检查事件</button>
                <button class="btn btn-warning" onclick="testEvents()">测试事件</button>
            </div>
        </div>

        <!-- 调试管理器 -->
        <div class="module-card" id="debug-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="debug-manager-status"></span>
                调试管理器
            </div>
            <div class="module-details" id="debug-manager-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="getDebugInfo()">获取调试信息</button>
                <button class="btn btn-warning" onclick="exportDebugData()">导出调试数据</button>
            </div>
        </div>

        <!-- 主客户端 -->
        <div class="module-card" id="simple-client-card">
            <div class="module-title">
                <span class="status-indicator" id="simple-client-status"></span>
                主客户端
            </div>
            <div class="module-details" id="simple-client-details">检查中...</div>
            <div class="module-actions">
                <button class="btn btn-success" onclick="initClient()">初始化客户端</button>
                <button class="btn btn-info" onclick="checkClient()">检查客户端</button>
                <button class="btn btn-warning" onclick="cleanupClient()">清理客户端</button>
            </div>
        </div>
    </div>

    <div class="log-section">
        <div class="log-header">
            <h3>📝 诊断日志</h3>
            <div>
                <button class="btn btn-primary" onclick="startDiagnostic()">开始诊断</button>
                <button class="btn btn-warning" onclick="clearLog()">清除日志</button>
                <button class="btn btn-info" onclick="exportLog()">导出日志</button>
            </div>
        </div>
        <div id="log"></div>
        </div>

    <script src="js/modules/module-loader.js"></script>
    <script>
        // 日志功能
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'ℹ️',
                'success': '✅',
                'warning': '⚠️',
                'error': '❌'
            };
            logDiv.innerHTML += `[${timestamp}] ${typeIcon[type]} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // 更新模块卡片状态
        function updateModuleCard(moduleId, status, details, className = 'info') {
            const card = document.getElementById(`${moduleId}-card`);
            const statusIndicator = document.getElementById(`${moduleId}-status`);
            const detailsElement = document.getElementById(`${moduleId}-details`);

            card.className = `module-card ${className}`;
            statusIndicator.className = `status-indicator status-${className}`;
            detailsElement.textContent = details;
        }

        // 更新概览
        function updateSummary() {
            const modules = ['ErrorHandler', 'WebSocketManager', 'ContentManager', 'StatusManager', 'UIManager', 'EventManager', 'DebugManager'];
            const loadedModules = modules.filter(m => window[m]).length;

            document.getElementById('total-modules').textContent = modules.length;
            document.getElementById('loaded-modules').textContent = loadedModules;

            if (window.simpleClient && window.simpleClient.wsManager && window.simpleClient.wsManager.isConnected()) {
                document.getElementById('ws-status').textContent = '✅';
            } else {
                document.getElementById('ws-status').textContent = '❌';
            }

            if (window.simpleClient) {
                document.getElementById('client-status').textContent = '✅';
            } else {
                document.getElementById('client-status').textContent = '❌';
            }
        }

        // 检查模块加载器
        function checkModuleLoader() {
            log('🔍 检查模块加载器...');
            if (window.ModuleLoader) {
                const status = window.ModuleLoader.getLoadStatus();
                updateModuleCard('module-loader', 'success',
                    `已加载: ${status.loadedModules.length}/${status.totalModules}`, 'success');
                log('✅ 模块加载器正常', 'success');
                log(`📊 加载状态: ${status.loadedModules.join(', ')}`, 'info');
            } else {
                updateModuleCard('module-loader', 'error', '模块加载器未加载', 'error');
                log('❌ 模块加载器未找到', 'error');
            }
        }

        // 加载所有模块
        async function loadAllModules() {
            log('📦 开始加载所有模块...');
            if (window.ModuleLoader) {
                try {
                    await window.ModuleLoader.loadAllModules();
                    log('✅ 所有模块加载完成', 'success');

                    // 检查模块可用性
                    if (window.ModuleLoader.checkModulesAvailability()) {
                        log('✅ 所有模块可用', 'success');

                        // 加载主客户端
                        if (!window.SimpleWebClient) {
                            log('📦 加载主客户端...', 'info');
                            window.ModuleLoader.loadModule('SimpleWebClient').then(() => {
                                log('✅ SimpleWebClient 加载完成', 'success');
                                if (window.SimpleWebClient && !window.simpleClient) {
                                    log('🚀 初始化客户端...', 'info');
                                    window.simpleClient = new window.SimpleWebClient();
                                }
                                setTimeout(runFullDiagnostic, 1000);
                            }).catch(error => {
                                log(`❌ SimpleWebClient 加载失败: ${error.message}`, 'error');
                            });
                        } else {
                            setTimeout(runFullDiagnostic, 1000);
                        }
                    } else {
                        log('❌ 部分模块不可用', 'error');
                    }
                } catch (error) {
                    log(`❌ 模块加载失败: ${error.message}`, 'error');
                }
            } else {
                log('❌ 模块加载器不可用', 'error');
            }
        }

        // 测试WebSocket
        function testWebSocket() {
            log('🔌 测试WebSocket连接...');
            if (window.simpleClient && window.simpleClient.wsManager) {
                const state = window.simpleClient.wsManager.getConnectionState();
                const connected = window.simpleClient.wsManager.isConnected();

                if (connected) {
                    updateModuleCard('websocket', 'success', 'WebSocket已连接', 'success');
                    log('✅ WebSocket连接正常', 'success');
                } else {
                    updateModuleCard('websocket', 'warning', `WebSocket状态: ${state}`, 'warning');
                    log(`⚠️ WebSocket未连接，状态: ${state}`, 'warning');
                }
            } else {
                updateModuleCard('websocket', 'error', 'WebSocket管理器未初始化', 'error');
                log('❌ WebSocket管理器不可用', 'error');
            }
        }

        // 重新连接WebSocket
        function reconnectWebSocket() {
            log('🔄 重新连接WebSocket...');
            if (window.simpleClient && window.simpleClient.wsManager) {
                window.simpleClient.wsManager.manualReconnect();
                log('🔄 WebSocket重连已触发', 'info');
                setTimeout(testWebSocket, 2000);
            } else {
                log('❌ WebSocket管理器不可用', 'error');
            }
        }

        // 发送测试消息
        function sendTestMessage() {
            log('📤 发送测试消息...');
            if (window.simpleClient) {
                const success = window.simpleClient.testSendMessage('诊断测试消息');
                if (success) {
                    log('✅ 测试消息发送成功', 'success');
                } else {
                    log('❌ 测试消息发送失败', 'error');
                }
            } else {
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 检查内容管理器
        function checkContent() {
            log('📄 检查内容管理器...');
            if (window.simpleClient && window.simpleClient.contentManager) {
                const hasContent = window.simpleClient.contentManager.hasReceivedContent();
                const currentContent = window.simpleClient.contentManager.getCurrentContent();

                updateModuleCard('content-manager', 'success',
                    `内容状态: ${hasContent ? '有内容' : '无内容'}`, 'success');
                log(`✅ 内容管理器正常，内容长度: ${currentContent ? currentContent.length : 0}`, 'success');
            } else {
                updateModuleCard('content-manager', 'error', '内容管理器未初始化', 'error');
                log('❌ 内容管理器不可用', 'error');
            }
        }

        // 清除内容
        function clearContent() {
            log('🧹 清除内容...');
            if (window.simpleClient) {
                window.simpleClient.forceClear();
                log('✅ 内容已清除', 'success');
                setTimeout(checkContent, 1000);
            } else {
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 检查状态管理器
        function checkStatus() {
            log('📊 检查状态管理器...');
            if (window.simpleClient && window.simpleClient.statusManager) {
                updateModuleCard('status-manager', 'success', '状态管理器正常', 'success');
                log('✅ 状态管理器正常', 'success');
            } else {
                updateModuleCard('status-manager', 'error', '状态管理器未初始化', 'error');
                log('❌ 状态管理器不可用', 'error');
            }
        }

        // 开始状态检查
        function startStatusCheck() {
            log('🔄 开始状态检查...');
            if (window.simpleClient && window.simpleClient.statusManager) {
                window.simpleClient.statusManager.startStatusCheck();
                log('✅ 状态检查已启动', 'success');
            } else {
                log('❌ 状态管理器不可用', 'error');
            }
        }

        // 测试UI管理器
        function testUI() {
            log('🎨 测试UI管理器...');
            if (window.simpleClient && window.simpleClient.uiManager) {
                window.simpleClient.uiManager.updateStatus('UI测试 - 正常', 'info');
                updateModuleCard('ui-manager', 'success', 'UI管理器正常', 'success');
                log('✅ UI管理器正常', 'success');
            } else {
                updateModuleCard('ui-manager', 'error', 'UI管理器未初始化', 'error');
                log('❌ UI管理器不可用', 'error');
            }
        }

        // 显示通知
        function showNotification() {
            log('🔔 显示通知...');
            if (window.simpleClient && window.simpleClient.uiManager) {
                window.simpleClient.uiManager.showNotification('诊断通知', 'info');
                log('✅ 通知已显示', 'success');
            } else {
                log('❌ UI管理器不可用', 'error');
            }
        }

        // 检查事件管理器
        function checkEvents() {
            log('🎯 检查事件管理器...');
            if (window.simpleClient && window.simpleClient.eventManager) {
                const events = window.simpleClient.eventManager.getBoundEvents();
                updateModuleCard('event-manager', 'success',
                    `已绑定事件: ${events.length}个`, 'success');
                log(`✅ 事件管理器正常，已绑定${events.length}个事件`, 'success');
            } else {
                updateModuleCard('event-manager', 'error', '事件管理器未初始化', 'error');
                log('❌ 事件管理器不可用', 'error');
            }
        }

        // 测试事件
        function testEvents() {
            log('🧪 测试事件...');
            if (window.simpleClient && window.simpleClient.eventManager) {
                window.simpleClient.eventManager.triggerEvent('diagnostic-test', { timestamp: Date.now() });
                log('✅ 测试事件已触发', 'success');
            } else {
                log('❌ 事件管理器不可用', 'error');
            }
        }

        // 获取调试信息
        function getDebugInfo() {
            log('🔍 获取调试信息...');
            if (window.simpleClient && window.simpleClient.debugManager) {
                const status = window.simpleClient.debugManager.getClientStatus();
                updateModuleCard('debug-manager', 'success', '调试管理器正常', 'success');
                log('✅ 调试信息已获取', 'success');
                console.log('调试状态:', status);
            } else {
                updateModuleCard('debug-manager', 'error', '调试管理器未初始化', 'error');
                log('❌ 调试管理器不可用', 'error');
            }
        }

        // 导出调试数据
        function exportDebugData() {
            log('📤 导出调试数据...');
            if (window.simpleClient && window.simpleClient.debugManager) {
                const status = window.simpleClient.debugManager.getClientStatus();
                const dataStr = JSON.stringify(status, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `debug-data-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                log('✅ 调试数据已导出', 'success');
            } else {
                log('❌ 调试管理器不可用', 'error');
            }
        }

        // 初始化客户端
        function initClient() {
            log('🚀 初始化客户端...');
            if (window.SimpleWebClient) {
                window.simpleClient = new window.SimpleWebClient();
                log('✅ 客户端初始化成功', 'success');
                setTimeout(runFullDiagnostic, 1000);
            } else {
                log('❌ SimpleWebClient类不可用', 'error');
            }
        }

        // 检查客户端
        function checkClient() {
            log('🔍 检查客户端...');
            if (window.simpleClient) {
                const wsConnected = window.simpleClient.isConnected();
                const wsState = window.simpleClient.getConnectionState();

                updateModuleCard('simple-client', 'success',
                    `客户端正常，WebSocket: ${wsConnected ? '已连接' : '未连接'}`, 'success');
                log(`✅ 客户端正常，WebSocket状态: ${wsState}`, 'success');
            } else {
                updateModuleCard('simple-client', 'error', '客户端未初始化', 'error');
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 清理客户端
        function cleanupClient() {
            log('🧹 清理客户端...');
            if (window.simpleClient) {
                window.simpleClient.cleanup();
                log('✅ 客户端已清理', 'success');
            } else {
                log('❌ 客户端未初始化', 'error');
            }
        }

        // 测试错误处理器
        function testErrorHandler() {
            log('🧪 测试错误处理器...');
            if (window.ErrorHandler && typeof window.ErrorHandler.handleError === 'function') {
                try {
                    throw new Error('测试错误');
                } catch (error) {
                    window.ErrorHandler.handleError(error, '诊断测试');
                }
                updateModuleCard('error-handler', 'success', '错误处理器正常', 'success');
                log('✅ 错误处理器测试完成', 'success');
            } else {
                updateModuleCard('error-handler', 'error', '错误处理器未正确加载', 'error');
                log('❌ 错误处理器不可用或方法缺失', 'error');
                if (window.ErrorHandler) {
                    log(`🔍 ErrorHandler对象: ${typeof window.ErrorHandler}`, 'info');
                    log(`🔍 handleError方法: ${typeof window.ErrorHandler.handleError}`, 'info');
                }
            }
        }

        // 清除错误日志
        function clearErrorLog() {
            log('🧹 清除错误日志...');
            if (window.ErrorHandler) {
                window.ErrorHandler.clearErrorLog();
                log('✅ 错误日志已清除', 'success');
            } else {
                log('❌ 错误处理器不可用', 'error');
            }
        }

        // 清除日志
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('🧹 诊断日志已清除', 'info');
        }

        // 导出日志
        function exportLog() {
            const logContent = document.getElementById('log').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostic-log-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('✅ 日志已导出', 'success');
        }

        // 运行完整诊断
        function runFullDiagnostic() {
            log('🔍 开始完整诊断...', 'info');

            // 检查各个模块
            checkModuleLoader();
            testErrorHandler();
            testWebSocket();
            checkContent();
            checkStatus();
            testUI();
            checkEvents();
            getDebugInfo();
            checkClient();

            // 更新概览
            updateSummary();

            log('✅ 完整诊断完成', 'success');
        }

        // 开始诊断
        function startDiagnostic() {
            log('🚀 开始系统诊断...', 'info');
            clearLog();

            // 先检查模块加载器
            checkModuleLoader();

            // 如果模块加载器可用，尝试加载模块
            if (window.ModuleLoader) {
                setTimeout(loadAllModules, 500);
            } else {
                log('❌ 模块加载器不可用，请刷新页面重试', 'error');
            }
        }

        // 页面加载完成后自动开始诊断
        window.addEventListener('load', () => {
            log('📄 诊断页面加载完成', 'info');
            setTimeout(startDiagnostic, 1000);
        });

        // 监听全局错误
        window.addEventListener('error', (event) => {
            log(`🔥 全局错误: ${event.error.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`🔥 未处理的Promise拒绝: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
