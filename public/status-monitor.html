<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>状态监控 - Cursor Web</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .monitor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .monitor-panel {
            background: #161616;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 16px;
            height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px dashed #333;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-timestamp {
            color: #666;
            margin-right: 8px;
        }
        .log-level-info { color: #4ade80; }
        .log-level-warn { color: #fbbf24; }
        .log-level-error { color: #ef4444; }
        .status-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #0a0a0a;
            border-radius: 8px;
        }
        .metric {
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ade80;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <div class="header-left">
                <a href="/" class="btn btn-back">
                    <span class="back-icon">←</span>
                    返回主页
                </a>
            </div>
            <div class="header-center">
                <h1>实例状态监控</h1>
            </div>
            <div class="header-right">
                <button id="clearLogsBtn" class="btn btn-secondary">清空日志</button>
                <button id="pauseBtn" class="btn btn-warning">暂停</button>
            </div>
        </header>

        <main class="main">
            <div class="status-summary">
                <div class="metric">
                    <div class="metric-value" id="totalInstances">0</div>
                    <div class="metric-label">总实例数</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="onlineInstances">0</div>
                    <div class="metric-label">在线实例</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="injectedInstances">0</div>
                    <div class="metric-label">已注入实例</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="totalClients">0</div>
                    <div class="metric-label">总客户端</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="totalProcesses">0</div>
                    <div class="metric-label">总进程</div>
                </div>
            </div>

            <div class="monitor-grid">
                <div class="monitor-panel">
                    <h3>状态变化日志</h3>
                    <div id="statusLogs"></div>
                </div>
                <div class="monitor-panel">
                    <h3>WebSocket事件日志</h3>
                    <div id="websocketLogs"></div>
                </div>
            </div>

            <div class="monitor-panel">
                <h3>实例详细状态</h3>
                <div id="instanceDetails" style="font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap;"></div>
            </div>
        </main>
    </div>

    <script>
        let isPaused = false;
        let websocket = null;
        let statusLogs = [];
        let websocketLogs = [];
        const maxLogs = 100;

        // 初始化
        window.addEventListener('load', function() {
            setupWebSocket();
            startStatusPolling();
            
            // 按钮事件
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
        });

        // 设置WebSocket连接
        function setupWebSocket() {
            try {
                const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                websocket = new WebSocket(`${protocol}//${location.host}`);
                
                websocket.onopen = () => {
                    addWebSocketLog('info', 'WebSocket连接已建立');
                    websocket.send(JSON.stringify({
                        type: 'register',
                        role: 'web',
                        instanceId: null // 监控所有实例
                    }));
                };

                websocket.onmessage = (event) => {
                    if (isPaused) return;
                    
                    try {
                        const message = JSON.parse(event.data);
                        addWebSocketLog('info', `收到消息: ${message.type}`);
                        
                        if (message.type === 'instance_status_update') {
                            addStatusLog('info', `实例 ${message.instanceId} 状态更新: ${message.status.connection.text} / ${message.status.inject.text}`);
                        } else if (message.type === 'clients_update') {
                            addStatusLog('info', '客户端列表更新');
                        }
                    } catch (e) {
                        addWebSocketLog('error', `解析消息失败: ${e.message}`);
                    }
                };

                websocket.onclose = () => {
                    addWebSocketLog('warn', 'WebSocket连接已关闭');
                    setTimeout(() => {
                        if (!websocket || websocket.readyState === WebSocket.CLOSED) {
                            setupWebSocket();
                        }
                    }, 5000);
                };

                websocket.onerror = (error) => {
                    addWebSocketLog('error', `WebSocket错误: ${error}`);
                };
            } catch (e) {
                addWebSocketLog('error', `设置WebSocket失败: ${e.message}`);
            }
        }

        // 开始状态轮询
        function startStatusPolling() {
            setInterval(async () => {
                if (isPaused) return;
                
                try {
                    const response = await fetch('/api/instances-status');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            updateSummary(data.data);
                            updateInstanceDetails(data.data);
                        }
                    }
                } catch (e) {
                    addStatusLog('error', `获取状态失败: ${e.message}`);
                }
            }, 2000);
        }

        // 更新摘要统计
        function updateSummary(allStatuses) {
            const instances = Object.keys(allStatuses);
            let onlineCount = 0;
            let injectedCount = 0;
            let totalClients = 0;
            let totalProcesses = 0;

            instances.forEach(instanceId => {
                const status = allStatuses[instanceId];
                if (status.connection?.status === 'connected') onlineCount++;
                if (status.inject?.status === 'injected') injectedCount++;
                if (status.summary) {
                    totalClients += status.summary.totalClients || 0;
                    totalProcesses += status.summary.totalProcesses || 0;
                }
            });

            document.getElementById('totalInstances').textContent = instances.length;
            document.getElementById('onlineInstances').textContent = onlineCount;
            document.getElementById('injectedInstances').textContent = injectedCount;
            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('totalProcesses').textContent = totalProcesses;
        }

        // 更新实例详细信息
        function updateInstanceDetails(allStatuses) {
            document.getElementById('instanceDetails').textContent = JSON.stringify(allStatuses, null, 2);
        }

        // 添加状态日志
        function addStatusLog(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            statusLogs.unshift({ timestamp, level, message });
            if (statusLogs.length > maxLogs) {
                statusLogs = statusLogs.slice(0, maxLogs);
            }
            updateStatusLogsDisplay();
        }

        // 添加WebSocket日志
        function addWebSocketLog(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            websocketLogs.unshift({ timestamp, level, message });
            if (websocketLogs.length > maxLogs) {
                websocketLogs = websocketLogs.slice(0, maxLogs);
            }
            updateWebSocketLogsDisplay();
        }

        // 更新状态日志显示
        function updateStatusLogsDisplay() {
            const container = document.getElementById('statusLogs');
            container.innerHTML = statusLogs.map(log => 
                `<div class="log-entry">
                    <span class="log-timestamp">${log.timestamp}</span>
                    <span class="log-level-${log.level}">[${log.level.toUpperCase()}]</span>
                    ${log.message}
                </div>`
            ).join('');
        }

        // 更新WebSocket日志显示
        function updateWebSocketLogsDisplay() {
            const container = document.getElementById('websocketLogs');
            container.innerHTML = websocketLogs.map(log => 
                `<div class="log-entry">
                    <span class="log-timestamp">${log.timestamp}</span>
                    <span class="log-level-${log.level}">[${log.level.toUpperCase()}]</span>
                    ${log.message}
                </div>`
            ).join('');
        }

        // 清空日志
        function clearLogs() {
            statusLogs = [];
            websocketLogs = [];
            updateStatusLogsDisplay();
            updateWebSocketLogsDisplay();
        }

        // 切换暂停状态
        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            btn.textContent = isPaused ? '继续' : '暂停';
            btn.className = isPaused ? 'btn btn-success' : 'btn btn-warning';
        }
    </script>
</body>
</html>