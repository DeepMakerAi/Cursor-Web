简单测试书签脚本（复制整行作为书签URL）：

javascript:(function(){alert('🔍 开始调试 Cursor 环境...');console.log('=== Claude Web 调试开始 ===');console.log('URL:', window.location.href);console.log('Protocol:', window.location.protocol);console.log('WebSocket支持:', typeof WebSocket !== 'undefined');try{const ws=new WebSocket('ws://localhost:3000');ws.onopen=function(){console.log('✅ WebSocket连接成功!');alert('✅ WebSocket连接成功！服务器通信正常');ws.send(JSON.stringify({type:'test',content:'来自Cursor的测试消息',timestamp:Date.now(),url:window.location.href}));setTimeout(()=>ws.close(),2000)};ws.onerror=function(error){console.log('❌ WebSocket错误:',error);alert('❌ WebSocket连接失败: '+error)};ws.onclose=function(event){console.log('🔌 WebSocket关闭 (code:'+event.code+')')}}catch(error){console.log('💥 WebSocket异常:',error);alert('💥 WebSocket创建失败: '+error.message)}console.log('页面div数量:',document.querySelectorAll('div').length);const chatKeywords=['chat','conversation','message','assistant','ai'];let foundElements=[];chatKeywords.forEach(keyword=>{document.querySelectorAll(`div[class*="${keyword}"]`).forEach((el,index)=>{if(index<3){foundElements.push(`${keyword}: ${el.className}`)}})});console.log('可能的聊天元素:',foundElements);alert('调试信息已输出到Console，请查看F12开发者工具');console.log('=== 调试结束 ===')})();


完整功能书签脚本（复制下面整行作为书签URL）：

javascript:(function(){console.log('🚀 Claude Web 增强版内容同步脚本已加载');class EnhancedCursorContentSync{constructor(){this.ws=null;this.lastContent='';this.chatContainer=null;this.syncInterval=null;this.retryCount=0;this.maxRetries=5;this.isDebugMode=true;this.init()}init(){this.log('🔧 初始化同步系统...');this.showNotification('🔍 正在查找聊天内容...','#2196F3');setTimeout(()=>{this.findAndTestContainer();this.connectWebSocket()},2000)}log(message,...args){if(this.isDebugMode){console.log(`[Claude Web] ${message}`,...args)}}findAndTestContainer(){this.log('🔍 开始查找聊天容器...');const selectors=['[data-testid*="chat"]','[data-testid*="conversation"]','[data-testid*="messages"]','[data-testid*="assistant"]','.chat-container','.chat-panel','.conversation-container','.messages-container','.chat-content','.chat-view','.chat-messages','.conversation-messages','div[class*="chat"]','div[class*="conversation"]','div[class*="message"]','div[class*="dialog"]','div[class*="assistant"]','div[class*="ai"]','[role="main"]','[role="dialog"]','[role="log"]','main','section[class*="chat"]','.right-panel','.side-panel','.assistant-panel','.sidebar-right','.panel-right'];let foundContainer=null;let foundMethod='';for(const selector of selectors){try{const containers=document.querySelectorAll(selector);for(const container of containers){if(this.isValidChatContainer(container)){foundContainer=container;foundMethod=`精确匹配: ${selector}`;break}}if(foundContainer)break}catch(error){this.log(`选择器错误 ${selector}:`,error.message)}}if(!foundContainer){this.log('🔍 尝试通过消息元素反向查找...');const messageSelectors=['div[class*="message"]','.message','[data-message]','[role="listitem"]','.chat-message','.user-message','.ai-message','.assistant-message','.bot-message','p[class*="message"]','span[class*="message"]'];for(const msgSelector of messageSelectors){try{const messages=document.querySelectorAll(msgSelector);if(messages.length>1){const parent=messages[0].closest('div[class*="chat"], div[class*="conversation"], div[class*="panel"], main, [role="main"], section');if(parent&&this.isValidChatContainer(parent)){foundContainer=parent;foundMethod=`消息反向查找: ${msgSelector} -> ${parent.tagName}.${parent.className}`;break}}}catch(error){this.log(`消息选择器错误 ${msgSelector}:`,error.message)}}}if(!foundContainer){this.log('🔍 尝试启发式查找...');const allDivs=document.querySelectorAll('div');let bestCandidate=null;let bestScore=0;for(const div of allDivs){const score=this.calculateContainerScore(div);if(score>bestScore&&score>50){bestScore=score;bestCandidate=div}}if(bestCandidate){foundContainer=bestCandidate;foundMethod=`启发式查找: 得分${bestScore}`}}if(foundContainer){this.chatContainer=foundContainer;this.log('✅ 找到聊天容器:',foundMethod);this.showNotification(`✅ 找到聊天区域\n${foundMethod}`,'#4CAF50');const testContent=this.getChatContent();if(testContent&&testContent.html.length>100){this.log('✅ 内容提取测试成功，长度:',testContent.html.length)}else{this.log('⚠️ 内容提取测试失败或内容太少');this.showNotification('⚠️ 找到容器但内容较少','#FF9800')}}else{this.log('❌ 未找到合适的聊天容器，使用body');this.chatContainer=document.body;this.showNotification('❌ 未找到聊天区域，使用整个页面','#FF5722')}this.outputDebugInfo()}isValidChatContainer(element){if(!element||!element.children)return false;const childCount=element.children.length;const textLength=element.textContent.length;const rect=element.getBoundingClientRect();return childCount>=2&&textLength>=50&&rect.width>200&&rect.height>100}calculateContainerScore(element){let score=0;try{const rect=element.getBoundingClientRect();const childCount=element.children.length;const textLength=element.textContent.length;const className=element.className.toLowerCase();if(childCount>=5)score+=20;if(textLength>=200)score+=20;if(rect.width>300)score+=10;if(rect.height>300)score+=10;if(rect.right>window.innerWidth*0.6)score+=15;if(rect.width>window.innerWidth*0.3)score+=10;const keywords=['chat','conversation','message','assistant','ai','dialog'];keywords.forEach(keyword=>{if(className.includes(keyword))score+=15});if(className.includes('sidebar')&&rect.width<300)score-=20;if(className.includes('menu'))score-=20;if(element.tagName==='SCRIPT'||element.tagName==='STYLE')score-=100}catch(error){return 0}return score}outputDebugInfo(){this.log('📊 页面调试信息:');this.log('  - URL:',window.location.href);this.log('  - Title:',document.title);this.log('  - 总div数量:',document.querySelectorAll('div').length);const classNames=new Set();document.querySelectorAll('div[class]').forEach(div=>{if(div.className&&div.className.length<100){div.className.split(' ').forEach(cls=>{if(cls.length>3)classNames.add(cls)})}});this.log('  - 主要class名称:',Array.from(classNames).slice(0,20))}connectWebSocket(){this.log('🔌 尝试连接 WebSocket...');const protocol=window.location.protocol==='https:'?'wss:':'ws:';const wsUrl=`${protocol}//localhost:3000`;try{this.ws=new WebSocket(wsUrl);this.ws.onopen=()=>{this.log('✅ WebSocket连接成功');this.showNotification('✅ 连接服务器成功!','#4CAF50');this.retryCount=0;this.sendInitialContent();this.startContentSync()};this.ws.onclose=(event)=>{this.log(`❌ WebSocket连接断开 (code: ${event.code})`);if(this.retryCount<this.maxRetries){this.retryCount++;this.showNotification(`🔄 连接断开，5秒后重试 (${this.retryCount}/${this.maxRetries})`,'#FF9800');setTimeout(()=>this.connectWebSocket(),5000)}else{this.showNotification('❌ 连接失败，请检查服务器','#FF5722')}};this.ws.onerror=(error)=>{this.log('🔥 WebSocket错误:',error);this.showNotification('🔥 连接错误，检查防火墙设置','#FF5722')}}catch(error){this.log('💥 WebSocket创建失败:',error);this.showNotification('💥 WebSocket不可用','#FF5722')}}getChatContent(){if(!this.chatContainer)return null;try{const clone=this.chatContainer.cloneNode(true);const removeSelectors=['script','style','link[rel="stylesheet"]','.tooltip','.popup','.dropdown','.overlay','.menu','[data-testid*="toolbar"]','[class*="toolbar"]','[class*="sidebar"]','button[class*="close"]','button[class*="minimize"]','input','textarea','.notification','.toast','.alert'];removeSelectors.forEach(selector=>{try{clone.querySelectorAll(selector).forEach(el=>el.remove())}catch(e){}});clone.querySelectorAll('*').forEach(el=>{try{[...el.attributes].forEach(attr=>{if(attr.name.startsWith('on')||attr.name.startsWith('data-')||attr.name==='style'||attr.name==='contenteditable'){el.removeAttribute(attr.name)}})}catch(e){}});return{html:clone.innerHTML,timestamp:Date.now(),url:window.location.href,title:document.title,containerInfo:{tagName:this.chatContainer.tagName,className:this.chatContainer.className,childrenCount:this.chatContainer.children.length}}}catch(error){this.log('❌ 获取内容失败:',error);return null}}sendContent(content){if(this.ws&&this.ws.readyState===WebSocket.OPEN){try{this.ws.send(JSON.stringify({type:'html_content',data:content}));this.log(`📤 内容已发送，大小: ${content.html.length} 字符`)}catch(error){this.log('📤 发送失败:',error)}}}sendInitialContent(){const content=this.getChatContent();if(content){this.sendContent(content);this.lastContent=content.html;this.log('📋 初始内容已发送')}}startContentSync(){this.syncInterval=setInterval(()=>{const content=this.getChatContent();if(content&&content.html!==this.lastContent){this.log('🔄 内容变化，同步中...');this.sendContent(content);this.lastContent=content.html}},3000);if(this.chatContainer){const observer=new MutationObserver((mutations)=>{let hasSignificantChange=false;mutations.forEach(mutation=>{if(mutation.type==='childList'&&mutation.addedNodes.length>0){for(const node of mutation.addedNodes){if(node.nodeType===Node.ELEMENT_NODE&&node.textContent&&node.textContent.trim().length>10){hasSignificantChange=true;break}}}});if(hasSignificantChange){setTimeout(()=>{const content=this.getChatContent();if(content&&content.html!==this.lastContent){this.sendContent(content);this.lastContent=content.html}},1000)}});observer.observe(this.chatContainer,{childList:true,subtree:true,characterData:true});this.log('👀 DOM监听器已启动')}}showNotification(message,color='#2196F3'){const oldNotification=document.getElementById('claude-web-notification');if(oldNotification){oldNotification.remove()}const notification=document.createElement('div');notification.id='claude-web-notification';notification.style.cssText=`position:fixed;top:20px;right:20px;z-index:99999;background:${color};color:white;padding:12px 16px;border-radius:6px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:320px;white-space:pre-line;word-wrap:break-word`;notification.textContent=message;try{document.body.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.remove()}},5000)}catch(error){this.log('通知显示失败:',error)}}}function initCursorSync(){if(window.CursorContentSync){console.log('Claude Web 同步脚本已存在');return}console.log('🚀 启动 Claude Web 同步脚本...');window.CursorContentSync=new EnhancedCursorContentSync()}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initCursorSync)}else{setTimeout(initCursorSync,1000)}})();
